<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Quant Lab PRO - Online</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0d1117; color: #c9d1d9; font-family: 'Inter', sans-serif; }
        .card-custom { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .param-value { color: #58a6ff; font-weight: bold; float: right; }
        .win { color: #3fb950; } .loss { color: #f85149; }
        input[type=range] { accent-color: #238636; width: 100%; }
        #status { font-size: 0.85rem; padding: 10px; border-radius: 5px; }
        .bg-wait { background: #21262d; color: #8b949e; }
        .bg-ok { background: rgba(56, 139, 253, 0.15); color: #58a6ff; }
    </style>
</head>
<body class="p-4">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="card-custom">
                    <h6 class="text-white border-bottom pb-2">Trading Console</h6>
                    <div id="status" class="bg-wait mb-3 mt-2">Caricamento dati...</div>
                    
                    <div class="mb-3">
                        <label class="small text-muted">Volume Spike</label> <span id="vV" class="param-value">3.0x</span>
                        <input type="range" id="vM" min="1" max="8" step="0.5" value="3" oninput="u()">
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted">Stop Loss (x ATR)</label> <span id="slV" class="param-value">2.0x</span>
                        <input type="range" id="slM" min="1" max="4" step="0.1" value="2" oninput="u()">
                    </div>
                    <div class="mb-4">
                        <label class="small text-muted">Take Profit (x ATR)</label> <span id="tpV" class="param-value">4.0x</span>
                        <input type="range" id="tpM" min="1" max="10" step="0.5" value="4" oninput="u()">
                    </div>
                    <button id="runBtn" class="btn btn-success w-100 fw-bold" disabled onclick="run()">ESEGUI BACKTEST</button>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card-custom">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0">Equity Curve</h5>
                        <h4 id="capRes" class="m-0 text-success">€10,000</h4>
                    </div>
                    <div style="height: 350px;"><canvas id="cEq"></canvas></div>
                </div>
                <div class="card-custom">
                    <h6 class="text-white">Storico Operazioni</h6>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-dark table-sm small">
                            <thead><tr><th>Ticker</th><th>Segnale</th><th>Ingresso</th><th>Uscita</th><th>Net %</th></tr></thead>
                            <tbody id="tLog"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = null; let chart = null;

        // CARICAMENTO AUTOMATICO AL LANCIO
        window.onload = async () => {
            const statusBox = document.getElementById('status');
            try {
                const response = await fetch('dati.json');
                if (!response.ok) throw new Error();
                db = await response.json();
                document.getElementById('runBtn').disabled = false;
                statusBox.className = "bg-ok mb-3 mt-2 text-center";
                statusBox.innerText = "✅ Dati caricati. Pronto!";
            } catch (err) {
                statusBox.style.background = "#f8514933";
                statusBox.style.color = "#f85149";
                statusBox.innerText = "❌ Errore: Assicurati che dati.json sia nel repository.";
            }
        };

        function u() {
            document.getElementById('vV').innerText = parseFloat(document.getElementById('vM').value).toFixed(1) + 'x';
            document.getElementById('slV').innerText = parseFloat(document.getElementById('slM').value).toFixed(1) + 'x';
            document.getElementById('tpV').innerText = parseFloat(document.getElementById('tpM').value).toFixed(1) + 'x';
        }

        async function run() {
            if(!db) return;
            const vMul = parseFloat(document.getElementById('vM').value);
            const slMul = parseFloat(document.getElementById('slM').value);
            const tpMul = parseFloat(document.getElementById('tpM').value);
            const fee = 0.001; 
            
            const tickers = Object.keys(db);
            const allDates = [...new Set(tickers.flatMap(t => db[t].d))].sort();
            
            const lookup = {};
            tickers.forEach(t => { 
                const dArr = db[t].d || [];
                lookup[t] = { p: {}, o: {}, v: {} };
                for(let i=0; i<dArr.length; i++) {
                    lookup[t].p[dArr[i]] = db[t].p[i];
                    lookup[t].o[dArr[i]] = db[t].o[i];
                    lookup[t].v[dArr[i]] = db[t].v[i];
                }
            });

            let cap = 10000; let trade = null; let trades = []; let equity = [];

            for (let i = 100; i < allDates.length - 1; i++) {
                const today = allDates[i];
                const nextDay = allDates[i+1];

                if (!trade) {
                    let best = null; let maxM = -Infinity;
                    for (const t of tickers) {
                        const pN = lookup[t].p[today];
                        const pO = lookup[t].p[allDates[i-90]];
                        if (pN && pO) {
                            const mom = (pN / pO) - 1;
                            if (mom > maxM) {
                                let vS=0; let vC=0;
                                for(let j=1; j<=20; j++) {
                                    const vP = lookup[t].v[allDates[i-j]];
                                    if(vP) { vS += vP; vC++; }
                                }
                                if (vC > 0 && lookup[t].v[today] > (vS/vC * vMul)) { maxM = mom; best = t; }
                            }
                        }
                    }
                    if (best) {
                        const enP = lookup[best].o[nextDay];
                        if(enP) {
                            let diffs = [];
                            for(let j=0; j<20; j++) {
                                const c1 = lookup[best].p[allDates[i-j]];
                                const c2 = lookup[best].p[allDates[i-j-1]];
                                if(c1 && c2) diffs.push(Math.abs(c1 - c2));
                            }
                            const atr = diffs.length > 0 ? (diffs.reduce((a,b)=>a+b,0)/diffs.length) : (enP * 0.02);
                            trade = { t: best, p: enP, sl: enP-(slMul*atr), tp: enP+(tpMul*atr), ds: today, di: nextDay };
                        }
                    }
                } else {
                    const cc = lookup[trade.t].p[today];
                    if (cc) {
                        let exP = null;
                        if (cc <= trade.sl) exP = trade.sl;
                        else if (cc >= trade.tp) exP = cc;

                        if (exP) {
                            const r = (exP / trade.p) - 1 - (fee * 2);
                            cap *= (1 + r);
                            trades.push({ t: trade.t, s: trade.ds, i: trade.di, o: today, r: (r*100).toFixed(2) });
                            equity.push({ d: today, v: cap.toFixed(2) });
                            trade = null;
                        }
                    }
                }
            }

            document.getElementById('capRes').innerText = "€" + Math.round(cap).toLocaleString();
            document.getElementById('tLog').innerHTML = trades.reverse().map(t => `
                <tr><td>${t.t}</td><td>${t.s}</td><td>${t.i}</td><td>${t.o}</td><td class="${t.r>=0?'win':'loss'}">${t.r}%</td></tr>
            `).join('');

            if(chart) chart.destroy();
            chart = new Chart(document.getElementById('cEq'), {
                type: 'line',
                data: { labels: equity.map(e=>e.d), datasets: [{ label: 'Equity €', data: equity.map(e=>e.v), borderColor: '#3fb950', pointRadius: 0, fill: true, backgroundColor: 'rgba(63, 185, 80, 0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
