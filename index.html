<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quant Lab PRO - Dashboard Completa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0d1117; color: #c9d1d9; font-family: 'Inter', sans-serif; }
        .card-custom { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .param-label { color: #ffffff; font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; display: block; }
        .param-desc { color: #58a6ff; font-size: 0.75rem; margin-bottom: 8px; display: block; line-height: 1.2; }
        .param-value { color: #3fb950; font-weight: bold; font-size: 1rem; float: right; }
        .stat-card { background: #0d1117; border: 1px solid #30363d; padding: 15px; border-radius: 8px; text-align: center; height: 100%; }
        .stat-label { font-size: 0.7rem; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.1rem; font-weight: bold; color: #ffffff; margin-top: 5px; }
        .win { color: #3fb950; } .loss { color: #f85149; }
        input[type=range] { accent-color: #238636; width: 100%; margin-bottom: 15px; cursor: pointer; }
        #status { font-size: 0.85rem; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; }
        .bg-ok { background: rgba(56, 139, 253, 0.15); color: #58a6ff; border: 1px solid #58a6ff; }
        
        /* Miglioramento tabella */
        .table { color: #c9d1d9; vertical-align: middle; }
        .table thead th { border-bottom: 2px solid #30363d; color: #8b949e; font-size: 0.75rem; text-transform: uppercase; }
        .table td { border-bottom: 1px solid #21262d; padding: 10px 5px; }
    </style>
</head>
<body class="p-4">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                <div class="card-custom">
                    <h5 class="text-white border-bottom pb-3 mb-3">Trading Console</h5>
                    <div id="status" class="bg-dark mb-4">Caricamento dati...</div>
                    
                    <div class="control-group">
                        <span class="param-value" id="vV">3.0x</span>
                        <label class="param-label">Volume Spike</label>
                        <small class="param-desc">Filtra titoli con esplosione di volumi rispetto alla media.</small>
                        <input type="range" id="vM" min="1" max="8" step="0.5" value="3" oninput="u()">
                    </div>

                    <div class="control-group">
                        <span class="param-value" id="slV">2.0x</span>
                        <label class="param-label">Stop Loss (ATR)</label>
                        <small class="param-desc">Protezione basata sulla volatilità media.</small>
                        <input type="range" id="slM" min="1" max="4" step="0.1" value="2" oninput="u()">
                    </div>

                    <div class="control-group">
                        <span class="param-value" id="tpV">4.0x</span>
                        <label class="param-label">Take Profit (ATR)</label>
                        <small class="param-desc">Obiettivo di guadagno basato sulla volatilità.</small>
                        <input type="range" id="tpM" min="1" max="10" step="0.5" value="4" oninput="u()">
                    </div>

                    <button id="runBtn" class="btn btn-success w-100 fw-bold mt-3 py-2" disabled onclick="run()">ESEGUI BACKTEST</button>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card-custom">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0">Equity Curve</h5>
                        <h4 id="capRes" class="m-0 text-success">€10,000</h4>
                    </div>
                    <div style="height: 320px;"><canvas id="cEq"></canvas></div>
                    
                    <div class="row mt-4">
                        <div class="col"><div class="stat-card"><div class="stat-label">Trade Totali</div><div id="sTot" class="stat-value">-</div></div></div>
                        <div class="col"><div class="stat-card"><div class="stat-label">Win Rate %</div><div id="sWin" class="stat-value">-</div></div></div>
                        <div class="col"><div class="stat-card"><div class="stat-label">Profit Factor</div><div id="sPF" class="stat-value">-</div></div></div>
                        <div class="col"><div class="stat-card"><div class="stat-label">Max DD</div><div id="sMDD" class="stat-value">-</div></div></div>
                        <div class="col"><div class="stat-card"><div class="stat-label">Sharpe</div><div id="sSR" class="stat-value">-</div></div></div>
                    </div>
                </div>

                <div class="card-custom">
                    <h6 class="text-white mb-3">Storico Operazioni Dettagliato</h6>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-dark table-sm small">
                            <thead>
                                <tr>
                                    <th>Ticker</th>
                                    <th>Data Segnale</th>
                                    <th>Entrata (Open)</th>
                                    <th>Prezzo In</th>
                                    <th>Uscita</th>
                                    <th>Prezzo Out</th>
                                    <th class="text-end">Net %</th>
                                </tr>
                            </thead>
                            <tbody id="tLog"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = null; let chart = null;

        function u() {
            document.getElementById('vV').innerText = parseFloat(document.getElementById('vM').value).toFixed(1) + 'x';
            document.getElementById('slV').innerText = parseFloat(document.getElementById('slM').value).toFixed(1) + 'x';
            document.getElementById('tpV').innerText = parseFloat(document.getElementById('tpM').value).toFixed(1) + 'x';
        }

        window.onload = async () => {
            const st = document.getElementById('status');
            try {
                const response = await fetch('dati.json');
                db = await response.json();
                document.getElementById('runBtn').disabled = false;
                st.className = "bg-ok mb-4";
                st.innerText = "✅ DATABASE PRONTO";
            } catch (err) {
                st.innerText = "❌ ERRORE: dati.json non trovato";
            }
        };

        async function run() {
            if(!db) return;
            const vMul = parseFloat(document.getElementById('vM').value);
            const slMul = parseFloat(document.getElementById('slM').value);
            const tpMul = parseFloat(document.getElementById('tpM').value);
            
            const tickers = Object.keys(db);
            const allDates = [...new Set(tickers.flatMap(t => db[t].d))].sort();
            const lookup = {};
            tickers.forEach(t => {
                lookup[t] = { p: {}, o: {}, v: {} };
                db[t].d.forEach((d, i) => {
                    lookup[t].p[d] = db[t].p[i];
                    lookup[t].o[d] = db[t].o[i];
                    lookup[t].v[d] = db[t].v[i];
                });
            });

            let cap = 10000; let trade = null; let trades = []; 
            let equityData = [{x: allDates[100], y: 10000}];
            let peak = 10000; let maxDD = 0; let returns = [];

            for (let i = 100; i < allDates.length - 1; i++) {
                if (i % 500 === 0) await new Promise(r => setTimeout(r, 1));
                const today = allDates[i];
                const nextDay = allDates[i+1];

                if (!trade) {
                    let best = null; let maxM = -Infinity;
                    for (const t of tickers) {
                        const pN = lookup[t].p[today];
                        const pO = lookup[t].p[allDates[i-90]];
                        if (pN && pO) {
                            const mom = (pN / pO) - 1;
                            if (mom > maxM) {
                                let vS=0, vC=0;
                                for(let j=1; j<=20; j++) {
                                    const vP = lookup[t].v[allDates[i-j]];
                                    if(vP) { vS += vP; vC++; }
                                }
                                if (vC > 0 && lookup[t].v[today] > (vS/vC * vMul)) { maxM = mom; best = t; }
                            }
                        }
                    }
                    if (best) {
                        const enP = lookup[best].o[nextDay];
                        if(enP) {
                            let diffs = [];
                            for(let j=0; j<20; j++) {
                                const c1 = lookup[best].p[allDates[i-j]];
                                const c2 = lookup[best].p[allDates[i-j-1]];
                                if(c1 && c2) diffs.push(Math.abs(c1 - c2));
                            }
                            const atr = diffs.length > 0 ? (diffs.reduce((a,b)=>a+b,0)/diffs.length) : (enP * 0.02);
                            trade = { t: best, p: enP, sl: enP-(slMul*atr), tp: enP+(tpMul*atr), ds: today, di: nextDay };
                        }
                    }
                } else {
                    const cc = lookup[trade.t].p[today];
                    if (cc) {
                        let exP = null;
                        if (cc <= trade.sl) exP = trade.sl;
                        else if (cc >= trade.tp) exP = cc;
                        
                        if (exP || today === allDates[allDates.length - 2]) {
                            exP = exP || cc;
                            const r = (exP / trade.p) - 1 - (0.001 * 2);
                            cap *= (1 + r);
                            returns.push(r);
                            trades.push({ 
                                t: trade.t, 
                                s: trade.ds, 
                                i: trade.di, 
                                ip: trade.p.toFixed(2), 
                                o: today, 
                                op: exP.toFixed(2), 
                                r: (r*100).toFixed(2) 
                            });
                            equityData.push({x: today, y: cap});
                            
                            if (cap > peak) peak = cap;
                            let dd = (peak - cap) / peak;
                            if (dd > maxDD) maxDD = dd;
                            trade = null;
                        }
                    }
                }
            }

            // Statistiche
            const winTrades = trades.filter(t => parseFloat(t.r) > 0);
            const winRate = trades.length > 0 ? (winTrades.length / trades.length * 100).toFixed(1) : 0;
            const grossProfit = winTrades.reduce((a, b) => a + parseFloat(b.r), 0);
            const lossTrades = trades.filter(t => parseFloat(t.r) <= 0);
            const grossLoss = Math.abs(lossTrades.reduce((a, b) => a + parseFloat(b.r), 0));
            const pf = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : grossProfit.toFixed(2);
            const avgRet = returns.length > 0 ? (returns.reduce((a,b)=>a+b,0) / returns.length) : 0;
            const stdDev = returns.length > 0 ? Math.sqrt(returns.map(x => Math.pow(x - avgRet, 2)).reduce((a,b)=>a+b,0) / returns.length) : 0;
            const sharpe = stdDev > 0 ? (avgRet / stdDev * Math.sqrt(252)).toFixed(2) : 0;

            document.getElementById('capRes').innerText = "€" + Math.round(cap).toLocaleString();
            document.getElementById('sTot').innerText = trades.length;
            document.getElementById('sWin').innerText = winRate + "%";
            document.getElementById('sPF').innerText = pf;
            document.getElementById('sMDD').innerText = (maxDD * 100).toFixed(1) + "%";
            document.getElementById('sSR').innerText = sharpe;
            
            document.getElementById('tLog').innerHTML = trades.reverse().map(t => `
                <tr>
                    <td class="fw-bold">${t.t}</td>
                    <td>${t.s}</td>
                    <td>${t.i}</td>
                    <td>€${t.ip}</td>
                    <td>${t.o}</td>
                    <td>€${t.op}</td>
                    <td class="text-end fw-bold ${t.r>=0?'win':'loss'}">${t.r}%</td>
                </tr>
            `).join('');

            if(chart) chart.destroy();
            chart = new Chart(document.getElementById('cEq'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Equity €',
                        data: equityData,
                        borderColor: '#3fb950',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        backgroundColor: 'rgba(63, 185, 80, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            ticks: { color: '#8b949e', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: { ticks: { color: '#8b949e' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
